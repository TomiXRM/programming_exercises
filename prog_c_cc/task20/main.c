#include <stdio.h>
#include <math.h>
#include "lib/mymath.h"
#include "lib/mymatrix.h"
/*
è‚©æŒã¡æ¢ã®æ›²ã’å•é¡Œ
ç‰‡æŒã¡ã°ã‚Šã®è‡ªç”±ç«¯ãŒé›†ä¸­è·é‡ã‚’å—ã‘ã‚‹ã¨ãï¼Œé•·ã•lã®ç‰‡æŒã¡ã°ã‚ŠãŒè‡ªç”±ç«¯ã«é›†ä¸­è·é‡W ã‚’å—ã‘ã‚‹å ´åˆï¼Œå›ºå®šç«¯ ã‹ã‚‰xã®è·é›¢ã«ã‚ã‚‹æ–­é¢ã®æ›²ã’ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆMã¯
M = -W(l-x)
ã§ã‚ã‚‹.ã¾ãŸï¼Œã¯ã‚Šã®ãŸã‚ã¿æ›²ç·šã‚’æ±‚ã‚ã‚‹åŸºæœ¬ã¨ãªã‚‹å¾®åˆ†æ–¹ç¨‹å¼ã¯æ¬¡å¼ã§è¡¨ã•ã‚Œã‚‹.
d^2y/dx^2 = -M/EI = W/EI(l-x)
ã“ã“ã§ï¼Œ E ï¼Œ I ã¯ãã‚Œãã‚Œãƒ¤ãƒ³ã‚°ç‡ãŠã‚ˆã³æ–­é¢äºŒæ¬¡ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆã§ã‚ã‚Šï¼Œé•·æ–¹å½¢æ–­é¢ã§ã¯
I = 1/12 * bh^3 ã§ã‚ã‚‹

ä¸Šè¨˜ã®å¾®åˆ†æ–¹ç¨‹å¼ã‚’æ•°å€¤çš„ã«è§£ãã€ç‰‡æŒã¡æ¢ã®ï½˜æ–¹å‘ã«ãŠã‘ã‚‹ï½™æ–¹å‘ã®å¤‰ç•°ã®åˆ†å¸ƒã‚’è¨ˆç®—ã™ã‚‹ã€‚
ã¾ãŸã€è¨ˆç®—çµæœã‚’ã‚°ãƒ©ãƒ•è¡¨ç¤ºã™ã‚‹ãŸã‚ã«Printfã§å‡ºåŠ›ã™ã‚‹ã€‚

ãŸã ã—ã€å…ˆç«¯ã«é›†ä¸­è·é‡W=30Nã‚’å—ã‘ã¦ã„ã‚‹ã‚‚ã®ã¨ã—ã€ãƒ¤ãƒ³ã‚°ç‡ã¯E=206GPaã¨ã™ã‚‹ã€‚

RungeKuttaæ³•ã‚’ç”¨ã„ã¦å¾®åˆ†æ–¹ç¨‹å¼ã‚’è§£ãã“ã¨ã€‚
*/

/*
+++++ãƒ¡ãƒ¢+++++

Euler-Bernoulliæ¢ç†è«–ã«åŸºã¥ã„ã¦ã€ç‰‡æŒã¡æ¢ã®ãŸã‚ã¿ã‚’è¨ˆç®—ã™ã‚‹ã¨

d^2 / dx^2 * (EI * d^2y/dx^2) = q(x)
- x : æ¢ã®é•·ã•
- y(x) : æ¢ã®ç¸¦æ–¹å‘ã®å¤‰ä½
- E : ãƒ¤ãƒ³ã‚°ç‡
- I : æ–­é¢äºŒæ¬¡ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆ

ä»Šå›ä½¿ã†æ¢ã¯é•·æ–¹å½¢ãªã‚“ã§ã€
I = bh^3 / 12 ã«ãªã‚‹

q(x) :  å˜ä½é•·ã•ã‚ãŸã‚Šã®è·é‡(ä»Šå›ã¯é›†ä¸­è·é‡ãªã®ã§0 or Î´é–¢æ•°)
ä»Šå›ã®å•é¡Œã¯ æ¢ã®å…ˆç«¯x=lã«é›†ä¸­è·é‡WãŒã‹ã‹ã£ã¦ã„ã‚‹ã®ã§ã€q(x) = WÎ´(x-l) ã«ãªã‚‹
Î´(x-l) ã¯ãƒ‡ãƒ«ã‚¿é–¢æ•°

ã“ã®å¾®åˆ†æ–¹ç¨‹å¼ã‚’Runge-Kuttaæ³•ã§è§£ãã“ã¨ã§ã€æ¢ã®ãŸã‚ã¿ã‚’æ±‚ã‚ã‚‹ã“ã¨ãŒã§ãã‚‹
EI * d^4y/dx^4 = 0 ã¨ã„ã†æ›²ã’ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆæ–¹ç¨‹å¼ã«ãªã‚‹

+++++å¢ƒç•Œæ¡ä»¶+++++
å›ºå®šç«¯(x = 0)
- å¤‰ä½ : y = 0
- å‚¾ã : dy/dx = 0
è‡ªç”±ç«¯(x = l)
- æ›²ã’ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆ : M = 0 (d^2y/dx^2 = 0)
- ã›ã‚“æ–­åŠ› : V = 0 (d^3y/dx^3 = 0)

+++++æ•°å€¤è¨ˆç®—+++++
4æ¬¡æ–¹ç¨‹å¼ã‚’4ã¤ã®1æ¬¡æ–¹ç¨‹å¼ã«åˆ†è§£
- y1 = y
- y2 = dy/dx
- y3 = d^2y/dx^2
- y4 = d^3y/dx^3

- dy1/dx = y2
- dy2/dx = y3
- dy3/dx = y4
- dy4/dx = q(x) / (EI)
*/

// å®šæ•°ã®å®šç¾©
#define E 206e9  // ãƒ¤ãƒ³ã‚°ç‡ [Pa]
#define W 30     // é›†ä¸­è·é‡ [N]
#define h_ 0.005 // åšã¿ [m]
#define b 0.1    // å¹… [m]
#define l 0.5    // é•·ã• [m]

// æ–­é¢äºŒæ¬¡ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆ I ã®è¨ˆç®—
#define I (1.0 / 12.0) * b *pow(h_, 3)

// Runge-Kuttaæ³•ã§ä½¿ã†å¾®åˆ†æ–¹ç¨‹å¼
double f1(double x, double y1, double y2, double y3, double y4) {
    return y2; // dy1/dx = y2
}

double f2(double x, double y1, double y2, double y3, double y4) {
    return y3; // dy2/dx = y3
}

double f3(double x, double y1, double y2, double y3, double y4) {
    return y4; // dy3/dx = y4
}

double f4(double x, double y1, double y2, double y3, double y4) {
    return -W * (l - x) / (E * I); // dy4/dx = q(x) / EI
}

// Runge-Kuttaæ³•ã‚’ç”¨ã„ãŸè¨ˆç®— (4æ¬¡ã®ãƒ«ãƒ³ã‚²ã‚¯ãƒƒã‚¿æ³•) å¼•æ•°ã¯é–¢æ•°ãƒã‚¤ãƒ³ã‚¿4ã¤
void runge_kutta_4th(
    double (*f1)(double, double, double, double, double),
    double (*f2)(double, double, double, double, double),
    double (*f3)(double, double, double, double, double),
    double (*f4)(double, double, double, double, double),
    double y[], double x0, double h, int steps, double result[]) {

    for (int i = 0; i < steps; i++) {
        double k1[4], k2[4], k3[4], k4[4];
        double x = x0 + i * h;

        // k1ã®è¨ˆç®—
        k1[0] = h * f1(x, y[0], y[1], y[2], y[3]);
        k1[1] = h * f2(x, y[0], y[1], y[2], y[3]);
        k1[2] = h * f3(x, y[0], y[1], y[2], y[3]);
        k1[3] = h * f4(x, y[0], y[1], y[2], y[3]);

        // k2ã®è¨ˆç®—
        k2[0] = h * f1(x + h / 2, y[0] + k1[0] / 2, y[1] + k1[1] / 2, y[2] + k1[2] / 2, y[3] + k1[3] / 2);
        k2[1] = h * f2(x + h / 2, y[0] + k1[0] / 2, y[1] + k1[1] / 2, y[2] + k1[2] / 2, y[3] + k1[3] / 2);
        k2[2] = h * f3(x + h / 2, y[0] + k1[0] / 2, y[1] + k1[1] / 2, y[2] + k1[2] / 2, y[3] + k1[3] / 2);
        k2[3] = h * f4(x + h / 2, y[0] + k1[0] / 2, y[1] + k1[1] / 2, y[2] + k1[2] / 2, y[3] + k1[3] / 2);

        // k3ã®è¨ˆç®—
        k3[0] = h * f1(x + h / 2, y[0] + k2[0] / 2, y[1] + k2[1] / 2, y[2] + k2[2] / 2, y[3] + k2[3] / 2);
        k3[1] = h * f2(x + h / 2, y[0] + k2[0] / 2, y[1] + k2[1] / 2, y[2] + k2[2] / 2, y[3] + k2[3] / 2);
        k3[2] = h * f3(x + h / 2, y[0] + k2[0] / 2, y[1] + k2[1] / 2, y[2] + k2[2] / 2, y[3] + k2[3] / 2);
        k3[3] = h * f4(x + h / 2, y[0] + k2[0] / 2, y[1] + k2[1] / 2, y[2] + k2[2] / 2, y[3] + k2[3] / 2);
        // k4ã®è¨ˆç®—
        k4[0] = h * f1(x + h, y[0] + k3[0], y[1] + k3[1], y[2] + k3[2], y[3] + k3[3]);
        k4[1] = h * f2(x + h, y[0] + k3[0], y[1] + k3[1], y[2] + k3[2], y[3] + k3[3]);
        k4[2] = h * f3(x + h, y[0] + k3[0], y[1] + k3[1], y[2] + k3[2], y[3] + k3[3]);
        k4[3] = h * f4(x + h, y[0] + k3[0], y[1] + k3[1], y[2] + k3[2], y[3] + k3[3]);

        // yã®æ›´æ–° (y1, y2, y3, y4)
        for (int j = 0; j < 4; j++) {
            y[j] += (k1[j] + 2 * k2[j] + 2 * k3[j] + k4[j]) / 6;
        }

        result[i] = y[0]; // y(x) ã‚’æ ¼ç´
    }
}

int main() {
    // åˆæœŸåŒ–
    double y[4] = {0, 0, 0, 0}; // y, dy/dx, d^2y/dx^2, d^3y/dx^3
    double result[100];
    double x0 = 0.0;
    double h = 0.01; // ã‚¹ãƒ†ãƒƒãƒ—ã‚µã‚¤ã‚º
    int steps = (int)(l / h);

    // Runge-Kuttaæ³•ã§è§£ã
    runge_kutta_4th(f1, f2, f3, f4, y, x0, h, steps, result);

    // çµæœã‚’å‡ºåŠ›
    for (int i = 0; i < steps; i++) {
        printf("%f,%f\n", i * h, result[i]);
    }

    // gnuplotã§ã‚°ãƒ©ãƒ•è¡¨ç¤º
    FILE *gp;
    gp = popen("gnuplot -persist", "w");
    fprintf(gp, "set title 'ç‰‡æŒã¡ã°ã‚Šã®xæ–¹å‘ã«ãŠã‘ã‚‹ yæ–¹å‘å¤‰ä½ã®åˆ†å¸ƒ'\n");
    fprintf(gp, "set xlabel 'x [m]'\n");
    fprintf(gp, "set ylabel 'y [m]'\n");
    fprintf(gp, "plot '-' w l\n");
    for (int i = 0; i < steps; i++) {
        fprintf(gp, "%f %f\n", i * h, result[i]);
    }
    fprintf(gp, "e\n");
    fflush(gp);
    pclose(gp);
    printf("ğŸ’ªãƒ¯ãƒƒã‚·ãƒ§ã‚¤ãƒ¯ãƒƒã‚·ãƒ§ã‚¤ğŸ’ª\n");
    return 0;
}
